<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üè∞ Donjon Isom√©trique - Grille System</title>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Courier New', monospace;
      background: #000;
      color: #e0e0e0;
      overflow: hidden;
    }

    #gameCanvas {
      display: block;
      background: #000;
      cursor: crosshair;
    }

    .ui {
      position: fixed;
      top: 20px;
      left: 20px;
      background: rgba(0, 0, 0, 0.8);
      border: 2px solid #d4af37;
      padding: 15px;
      border-radius: 5px;
      min-width: 250px;
    }

    .ui h2 {
      color: #d4af37;
      margin-bottom: 10px;
      font-size: 16px;
    }

    .ui p {
      margin: 5px 0;
      font-size: 13px;
      color: #ccc;
    }

    .ui .value {
      color: #fff;
      font-weight: bold;
    }

    .controls {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.8);
      border: 2px solid #d4af37;
      padding: 15px 30px;
      border-radius: 5px;
      text-align: center;
    }

    .controls p {
      color: #d4af37;
      margin: 5px 0;
      font-size: 13px;
    }

    button {
      margin: 10px 5px 0;
      padding: 8px 16px;
      background: #654321;
      color: #d4af37;
      border: 2px solid #d4af37;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
    }

    button:hover {
      background: #8B4513;
      transform: translateY(-2px);
    }
  </style>
</head>
<body>

<canvas id="gameCanvas" width="1920" height="1080"></canvas>

<div class="ui">
  <h2>üè∞ DONJON ISOM√âTRIQUE</h2>
  <p>Position: <span class="value" id="playerPos">0, 0</span></p>
  <p>Grille: <span class="value" id="gridSize">100x100</span></p>
  <p>Chemin: <span class="value" id="pathLength">0</span> tuiles</p>
  <p>Salles: <span class="value" id="roomCount">0</span></p>
  <p>Zoom: <span class="value" id="zoomLevel">1.0x</span></p>
  <p>FPS: <span class="value" id="fps">60</span></p>
</div>

<div class="controls">
  <p>üéÆ WASD / Fl√®ches: D√©placer | Molette: Zoom | Clic droit: D√©placer cam√©ra</p>
  <button id="btnRegen">üîÑ Nouveau Donjon</button>
  <button id="btnZoomIn">üîç+</button>
  <button id="btnZoomOut">üîç-</button>
  <button id="btnFocus">üìç Focus Joueur</button>
</div>

<script src="js/grid-dungeon-system.js"></script>

<script>
/**
 * üéÆ GAME LOOP
 */
class GridDungeonGame {
  constructor() {
    // G√©n√©rateur (grille 100x100)
    this.generator = new GridDungeonGenerator(100, 100);
    
    // Renderer
    this.renderer = new GridIsometricRenderer('gameCanvas');
    
    // Donjon actuel
    this.dungeon = null;
    
    // Joueur
    this.player = {
      x: 50,
      y: 50,
      speed: 0.15,
      isOnDestinyNode: false
    };
    
    // Input
    this.keys = {};
    
    // Contr√¥le cam√©ra avec souris
    this.isDragging = false;
    this.dragStart = { x: 0, y: 0 };
    this.cameraFollowPlayer = true; // Par d√©faut, suit le joueur
    
    // FPS
    this.lastTime = performance.now();
    this.fps = 60;
    
    this.init();
  }

  init() {
    console.log('üéÆ Initialisation...');
    
    // G√©n√©rer donjon
    this.regenerate();
    
    // Input
    this.setupInput();
    
    // Loop
    this.gameLoop();
    
    console.log('‚úÖ Pr√™t !');
  }

  regenerate() {
    console.log('üîÑ G√©n√©ration...');
    this.dungeon = this.generator.generate();
    
    // Placer joueur au d√©but
    this.player.x = this.dungeon.start.x;
    this.player.y = this.dungeon.start.y;
    
    this.updateUI();
  }

  setupInput() {
    // Keyboard
    window.addEventListener('keydown', (e) => {
      this.keys[e.key.toLowerCase()] = true;
      
      if (e.key === ' ') {
        e.preventDefault();
        this.regenerate();
      }
    });

    window.addEventListener('keyup', (e) => {
      this.keys[e.key.toLowerCase()] = false;
    });

    // Zoom (molette)
    this.renderer.canvas.addEventListener('wheel', (e) => {
      e.preventDefault();
      const delta = e.deltaY > 0 ? -0.1 : 0.1;
      this.renderer.camera.zoom = Math.max(0.3, Math.min(2.5, this.renderer.camera.zoom + delta));
      this.updateUI();
    });

    // D√©placement cam√©ra avec clic droit ou clic milieu
    this.renderer.canvas.addEventListener('mousedown', (e) => {
      if (e.button === 2 || e.button === 1) { // Clic droit ou milieu
        e.preventDefault();
        this.isDragging = true;
        this.cameraFollowPlayer = false; // Arr√™ter de suivre le joueur
        this.dragStart = { x: e.clientX, y: e.clientY };
      }
    });

    window.addEventListener('mousemove', (e) => {
      if (this.isDragging) {
        const dx = e.clientX - this.dragStart.x;
        const dy = e.clientY - this.dragStart.y;
        
        // D√©placer la cam√©ra (inverse du drag)
        this.renderer.camera.x -= dx / this.renderer.camera.zoom;
        this.renderer.camera.y -= dy / this.renderer.camera.zoom;
        
        this.dragStart = { x: e.clientX, y: e.clientY };
      }
    });

    window.addEventListener('mouseup', (e) => {
      if (e.button === 2 || e.button === 1) {
        this.isDragging = false;
      }
    });

    // D√©sactiver menu contextuel
    this.renderer.canvas.addEventListener('contextmenu', (e) => {
      e.preventDefault();
    });

    // Boutons
    document.getElementById('btnRegen').onclick = () => this.regenerate();
    
    document.getElementById('btnZoomIn').onclick = () => {
      this.renderer.camera.zoom = Math.min(2.5, this.renderer.camera.zoom + 0.2);
      this.updateUI();
    };
    
    document.getElementById('btnZoomOut').onclick = () => {
      this.renderer.camera.zoom = Math.max(0.3, this.renderer.camera.zoom - 0.2);
      this.updateUI();
    };
    
    document.getElementById('btnFocus').onclick = () => {
      this.cameraFollowPlayer = true; // R√©activer le suivi du joueur
    };
  }

  update(dt) {
    // D√©placement
    let dx = 0;
    let dy = 0;

    if (this.keys['arrowup'] || this.keys['w']) dy -= 1;
    if (this.keys['arrowdown'] || this.keys['s']) dy += 1;
    if (this.keys['arrowleft'] || this.keys['a']) dx -= 1;
    if (this.keys['arrowright'] || this.keys['d']) dx += 1;

    // Normaliser diagonale
    if (dx !== 0 && dy !== 0) {
      dx *= 0.707;
      dy *= 0.707;
    }

    const newX = this.player.x + dx * this.player.speed;
    const newY = this.player.y + dy * this.player.speed;

    // Collision (sol seulement)
    if (this.canWalkOn(newX, newY)) {
      this.player.x = newX;
      this.player.y = newY;
    }

    // V√©rifier N≈ìud de Destin
    const tile = this.getTileAt(Math.round(this.player.x), Math.round(this.player.y));
    this.player.isOnDestinyNode = (tile === TileType.DESTINY);

    this.updateUI();
  }

  canWalkOn(x, y) {
    const gx = Math.round(x);
    const gy = Math.round(y);
    const tile = this.getTileAt(gx, gy);
    
    return tile === TileType.FLOOR || 
           tile === TileType.ROOM_FLOOR || 
           tile === TileType.DESTINY || 
           tile === TileType.CORRUPTED ||
           tile === TileType.ENTRANCE ||
           tile === TileType.EXIT;
  }

  getTileAt(x, y) {
    if (y < 0 || y >= this.dungeon.grid.length || 
        x < 0 || x >= this.dungeon.grid[0].length) {
      return TileType.VOID;
    }
    return this.dungeon.grid[y][x];
  }

  render() {
    this.renderer.render(this.dungeon, this.player, this.cameraFollowPlayer);
  }

  updateUI() {
    document.getElementById('playerPos').textContent = 
      `${Math.round(this.player.x)}, ${Math.round(this.player.y)}`;
    
    document.getElementById('gridSize').textContent = 
      `${this.dungeon.grid[0].length}x${this.dungeon.grid.length}`;
    
    document.getElementById('pathLength').textContent = this.dungeon.path.length;
    document.getElementById('roomCount').textContent = this.dungeon.rooms.length;
    document.getElementById('zoomLevel').textContent = this.renderer.camera.zoom.toFixed(1) + 'x';
    document.getElementById('fps').textContent = Math.round(this.fps);
  }

  gameLoop() {
    const now = performance.now();
    const dt = (now - this.lastTime) / 1000;
    this.lastTime = now;

    this.fps = 1 / dt;

    this.update(dt);
    this.render();

    requestAnimationFrame(() => this.gameLoop());
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// START
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

window.addEventListener('DOMContentLoaded', () => {
  console.log('üè∞ THE LAST COVENANT - Donjon Isom√©trique (Grid)');
  const game = new GridDungeonGame();
  window.game = game;
});
</script>

</body>
</html>
