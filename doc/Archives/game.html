<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Donjon JDR â€“ En Jeu</title>
<!-- âœ… DESIGN SYSTEM AAA+ (doit Ãªtre chargÃ© EN PREMIER) -->
<link rel="stylesheet" href="css/design-system.css">
<link rel="stylesheet" href="css/game.css">
<link rel="stylesheet" href="css/game-ui-new.css">
<!-- âŒ SUPPRIMÃ‰ deck-hand.css -->
<link rel="stylesheet" href="css/event-modals.css">
<!-- âœ… AJOUTÃ‰ : ThÃ¨me Dark Medieval -->
<link rel="stylesheet" href="css/dark-medieval-theme.css">
<!-- âœ… AJOUTÃ‰ : Buffs Passifs Dark -->
<link rel="stylesheet" href="css/passive-buffs-dark.css">
<!-- âœ… NOUVEAU : Combat System Tactique -->
<link rel="stylesheet" href="css/combat-system.css">
<link rel="stylesheet" href="css/shop-modal-aaa.css">
<link rel="stylesheet" href="css/rest-modal-aaa.css">
<link rel="stylesheet" href="css/event-modal-aaa.css">
<!-- âœ… NOUVEAU : Modales AAA+ Corridor et Salles -->
<link rel="stylesheet" href="css/event-modal-corridor.css">
<link rel="stylesheet" href="css/event-modal-rooms.css">
<!-- âœ… NOUVEAU : Loot Reveal Animations -->
<link rel="stylesheet" href="css/loot-reveal.css">
<!-- âœ… NOUVEAU : Corruption System Visuel -->
<link rel="stylesheet" href="css/corruption-system.css">
<!-- âœ… NOUVEAU : Item Inspection Modal -->
<link rel="stylesheet" href="css/item-inspection-modal.css">
<!-- âœ… NOUVEAU : Narrator System -->
<link rel="stylesheet" href="css/narrator-system.css">
<!-- âœ… NOUVEAU : DÃ© du Destin System -->
<link rel="stylesheet" href="css/dice-system.css">
<!-- âœ… NOUVEAU : Camp/Village System -->
<link rel="stylesheet" href="css/camp.css">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Grenze+Gotisch:wght@400;700&family=Press+Start+2P&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Crimson+Text:wght@400;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>

<div class="dungeon-background"></div>
<div class="vignette"></div>

<header class="game-header">
  <div class="header-left">
    <h1 class="game-title">â˜  Le Donjon des DamnÃ©s â˜ </h1>
  </div>
  <div class="header-center">
    <div class="turn-display" id="turnDisplay">
      <span class="turn-label">Tour de</span>
      <span class="turn-player" id="turnPlayer">Chargement...</span>
    </div>
  </div>
  <div class="header-right">
    <button class="btn-exit" id="btnReturnToCamp" style="margin-right: 10px;">
      â›º Retour au Camp
    </button>
    <button class="btn-exit" onclick="window.location.href='index.html'">
      ğŸšª Menu Principal
    </button>
  </div>
</header>

<div class="game-container">
  
  <!-- SIDEBAR GAUCHE -->
  <aside class="sidebar sidebar-left">
    
    <!-- PANNEAU HÃ‰ROS -->
    <div class="panel stone-panel">
      <h2 class="panel-title">âš” Votre HÃ©ros</h2>
      <div id="currentPlayerInfo" class="hero-card">
        <div class="hero-portrait">
          <div class="portrait-icon" id="heroIcon">?</div>
        </div>
        
        <div class="level-badge-center" id="levelBadgeCenter">Niv. 1</div>
        
        <div class="hero-stats">
          <div class="hero-name" id="heroName">Chargement...</div>
          <div class="hero-class" id="heroClass">Classe</div>
          
          <!-- âœ… MODIFIÃ‰ : Barres HP/XP visuelles -->
          <div class="hp-bar-container">
            <span class="stat-label">â¤ï¸ HP</span>
            <div class="hp-bar-wrapper">
              <div class="hp-bar" id="heroHPBar"></div>
              <span class="hp-text" id="heroHP">10/10</span>
            </div>
          </div>
          
          <div class="xp-bar-container">
            <span class="stat-label">â­ XP</span>
            <div class="xp-bar-wrapper">
              <div class="xp-bar" id="heroXPBar"></div>
              <span class="xp-text" id="heroXP">0/100</span>
            </div>
          </div>
          
          <div class="stat-row">
            <span class="stat-item">âš”ï¸ <span id="heroATK">4</span></span>
            <span class="stat-item">ğŸ›¡ï¸ <span id="heroDEF">3</span></span>
          </div>
          
          <div class="stat-row">
            <span class="stat-item">ğŸ’° <span id="heroGold">0</span></span>
            <span class="stat-item">ğŸ“ <span id="heroPosition">0/450</span></span>
          </div>
          
          <!-- Bouton compÃ©tences -->
          <button class="btn-skill-compact" id="skillBtn" onclick="game.showSkillTree()" style="display:none;">
            <span id="heroSkillPoints">0</span> ğŸŒŸ CompÃ©tences
          </button>
        </div>
      </div>
    </div>

    <!-- PANNEAU INVENTAIRE -->
    <div class="panel stone-panel">
      <h2 class="panel-title">ğŸ’ Inventaire</h2>
      <div class="inventory-grid" id="inventoryGrid">
        <div class="inv-slot"></div>
        <div class="inv-slot"></div>
        <div class="inv-slot"></div>
        <div class="inv-slot"></div>
        <div class="inv-slot"></div>
        <div class="inv-slot"></div>
      </div>
      
      <!-- âœ… Bouton dÃ© avec VRAI CUBE 3D OSSEUX -->
      <button class="btn-dice-sidebar" id="rollBtn">
        <!-- ğŸ’€ VRAI CUBE 3D OSSEUX qui flotte -->
        <div class="dice-3d-button-container">
          <div class="dice-3d-button">
            <div class="dice-face-btn front">1</div>
            <div class="dice-face-btn back">6</div>
            <div class="dice-face-btn right">2</div>
            <div class="dice-face-btn left">5</div>
            <div class="dice-face-btn top">3</div>
            <div class="dice-face-btn bottom">4</div>
          </div>
        </div>
        <span class="dice-label">LANCER LE DÃ‰</span>
      </button>
    </div>

  </aside>

  <!-- ZONE CENTRALE -->
  <main class="game-main">
    <div class="canvas-container">
      <canvas id="gameCanvas" width="1200" height="700"></canvas>
      <div class="canvas-overlay">
        <div class="compass" id="compass">
          <div class="compass-needle" id="compassNeedle">
            <span style="font-size: 20px;">ğŸšª</span>
          </div>
        </div>
        
        <!-- ContrÃ´les de camÃ©ra -->
        <div class="camera-controls">
          <button class="camera-btn" id="zoomInBtn" title="Zoom +">
            <span style="font-size: 20px;">+</span>
          </button>
          <button class="camera-btn" id="zoomOutBtn" title="Zoom -">
            <span style="font-size: 20px;">âˆ’</span>
          </button>
          <button class="camera-btn" id="recenterBtn" title="Recentrer sur le joueur">
            <span style="font-size: 16px;">ğŸ¯</span>
          </button>
          <button class="camera-btn" id="soundToggleBtn" title="Son activÃ©">
            <span style="font-size: 16px;" id="soundIcon">ğŸ”Š</span>
          </button>
          <button class="camera-btn" id="musicToggleBtn" title="Musique activÃ©e">
            <span style="font-size: 16px;" id="musicIcon">ğŸµ</span>
          </button>
          <div class="zoom-indicator" id="zoomIndicator">100%</div>
          
          <!-- FPS Counter -->
          <div style="position: absolute; top: 10px; left: 10px; font-family: monospace; font-size: 14px; background: rgba(0,0,0,0.7); padding: 5px 10px; border-radius: 4px;">
            <div id="fpsDisplay" style="color: #0f0;">FPS: 60</div>
            <div id="frameTimeDisplay" style="color: #888; font-size: 11px;">Frame: 16.67 ms</div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- SIDEBAR DROITE -->
  <aside class="sidebar sidebar-right">
    
    <div class="panel stone-panel">
      <h2 class="panel-title">ğŸ‘¥ Aventuriers</h2>
      <div class="players-scroll" id="playersList">
      </div>
    </div>

    <div class="panel stone-panel">
      <h2 class="panel-title">ğŸ“œ Journal</h2>
      <div class="event-log" id="eventLog">
        <div class="log-entry">
          <span class="log-icon">âš¡</span>
          <span class="log-text">La partie commence...</span>
        </div>
      </div>
      
      <!-- âœ… AJOUTÃ‰ : Section Buffs Passifs -->
      <div id="passiveBuffsContainer">
        <h3>ğŸ’« Buffs Actifs</h3>
        <div id="passiveBuffsList">
          <div class="no-buffs">Aucun buff actif</div>
        </div>
      </div>
    </div>

  </aside>

</div>

<!-- MODAL DÃ‰ -->
<div id="diceModal" class="modal">
  <div class="modal-content dice-modal-content">
    <div class="dice-container">
      <div class="pixel-dice" id="pixelDice">
        <div class="dice-face">?</div>
      </div>
    </div>
    <div class="dice-result" id="diceResult" style="display:none;">
      <span class="result-number">6</span>
    </div>
    <p class="dice-text" id="diceText">Lancement du dÃ©...</p>
  </div>
</div>

<!-- MODAL INFO -->
<div id="infoModal" class="modal">
  <div class="modal-content stone-panel">
    <h2 class="panel-title" id="infoTitle">Information</h2>
    <div id="infoContent" class="modal-text"></div>
    <button class="btn-blood" id="infoCloseBtn">Continuer</button>
  </div>
</div>

<!-- SCRIPTS -->
<script src="js/config.js"></script>
<script src="js/classes.js"></script>
<!-- âœ… NOUVEAU : Items Database (doit Ãªtre chargÃ© AVANT inventory) -->
<script src="js/items-database.js"></script>
<!-- âœ… NOUVEAU : Enemies Database (Corridor/Room/Boss) -->
<script src="js/enemies-index.js"></script>
<!-- âœ… NOUVEAU : Economy System (Rubis/Or) -->
<script src="js/economy-system.js"></script>
<!-- âœ… NOUVEAU : Camp/Village System -->
<script src="js/camp.js"></script>
<script src="js/inventory.js"></script>
<script src="js/dice-lexicon.js"></script>
<script src="js/destiny-cards.js"></script>
<script src="js/card-system.js"></script>
<script src="js/audio.js"></script>
<script src="js/events.js"></script>
<script src="js/events-extended.js"></script>
<script src="js/progression.js"></script>
<script src="js/achievements.js"></script>

<!-- âœ… SYSTÃˆME ISOMÃ‰TRIQUE -->
<script src="js/dungeon-nodes.js"></script>
<script src="js/destiny-nodes.js"></script>
<script src="js/dungeon-linear-generator.js"></script>
<script src="js/isometric-renderer-cubes.js"></script>

<!-- âŒ ANCIEN SYSTÃˆME 2D DÃ‰SACTIVÃ‰ -->
<!-- <script src="js/texture-generator.js"></script> -->
<!-- <script src="js/lighting-system.js"></script> -->
<!-- <script src="js/dungeon.js"></script> -->
<!-- <script src="js/renderer.js"></script> -->
<!-- <script src="js/renderer-advanced.js"></script> -->
<!-- <script src="js/game.js"></script> -->

<script src="js/modal-sounds.js"></script>
<script src="js/event-modals.js"></script>
<script src="js/combat.js"></script>

<!-- âœ… AJOUTÃ‰ : SystÃ¨me de buffs passifs -->
<script src="js/passive-buffs.js"></script>

<!-- âœ… AJOUTÃ‰ : Indicateurs de direction -->
<script src="js/path-indicators.js"></script>

<!-- âœ… AJOUTÃ‰ : Mise Ã  jour barres HP/XP -->
<script src="js/health-bars-update.js"></script>

<!-- âœ… AJOUTÃ‰ : Animation joueur saut de puce -->
<script src="js/player-animation.js"></script>
<script src="js/combat-audio-system.js"></script>

<!-- âœ… NOUVEAU MOTEUR DE JEU ISOMÃ‰TRIQUE -->
<script src="js/game-iso.js"></script>
<script src="js/shop-modal-aaa.js"></script>
<script src="js/rest-modal-aaa.js"></script>
<script src="js/event-modal-aaa.js"></script>
<!-- âœ… NOUVEAU : Modales AAA+ Corridor -->
<script src="js/event-modal-corridor.js"></script>
<!-- âœ… NOUVEAU : Loot System (Particles + Reveal) -->
<script src="js/particle-system.js"></script>
<script src="js/loot-reveal-system.js"></script>
<!-- âœ… NOUVEAU : Corruption System Visuel -->
<script src="js/corruption-system.js"></script>
<!-- âœ… NOUVEAU : Items Lore Integration System -->
<script src="js/items-lore-integration.js"></script>
<!-- âœ… NOUVEAU : Narrator System -->
<script src="js/narrator-system.js"></script>

<!-- âœ… NOUVEAU : DÃ© du Destin System -->
<script src="js/dice-visual-system.js"></script>
<script src="js/dice-destiny-core.js"></script>

<!-- ğŸ§ª BOUTONS TEST -->
<div style="position: fixed; top: 70px; right: 10px; z-index: 9999; display: flex; flex-direction: column; gap: 10px;">

  <!-- Bouton Test Combat -->
  <button id="test-combat-btn" style="
    padding: 12px 20px;
    background: linear-gradient(135deg, #8B0000 0%, #DC143C 100%);
    color: white;
    border: 2px solid #FFD700;
    border-radius: 8px;
    font-family: 'Cinzel', serif;
    cursor: pointer;
    font-size: 14px;
    box-shadow: 0 0 20px rgba(139, 0, 0, 0.5);
    transition: all 0.3s ease;
  " onmouseover="this.style.transform='scale(1.05)'"
     onmouseout="this.style.transform='scale(1)'">
    âš”ï¸ TEST COMBAT
  </button>

  <!-- Bouton Test DÃ© du Destin -->
  <button id="test-dice-destiny-btn" style="
    padding: 12px 20px;
    background: linear-gradient(135deg, #4B0082 0%, #9370DB 100%);
    color: white;
    border: 2px solid #FFD700;
    border-radius: 8px;
    font-family: 'Cinzel', serif;
    cursor: pointer;
    font-size: 14px;
    box-shadow: 0 0 20px rgba(75, 0, 130, 0.5);
    transition: all 0.3s ease;
  " onmouseover="this.style.transform='scale(1.05)'"
     onmouseout="this.style.transform='scale(1)'">
    ğŸ² TEST DÃ‰ DESTIN
  </button>

</div>

<script>
// ğŸ§ª Script de test pour le Combat System
document.getElementById('test-combat-btn').addEventListener('click', function() {
  console.log('ğŸ§ª Lancement test Combat System...');
  
  // CrÃ©er joueur test
  const testPlayer = {
    id: 'player_test',
    name: 'Toi',
    sprite: 'ğŸ§™',
    hp: 120,
    maxHp: 120,
    atk: 25,
    def: 10,
    speed: 5,
    isAlly: true,
    isPlayer: true,
    stress: 30,
    corruption: 20
  };
  
  // CrÃ©er compagnon test
  const testKnight = {
    id: 'knight_test',
    name: 'Chevalier',
    sprite: 'âš”ï¸',
    hp: 85,
    maxHp: 85,
    atk: 20,
    def: 15,
    speed: 4,
    isAlly: true,
    isPlayer: false
  };
  
  // CrÃ©er ennemis test
  const enemies = [
    {
      id: 'orc1',
      name: 'Orc Guerrier',
      sprite: 'ğŸ‘¹',
      hp: 45,
      maxHp: 45,
      atk: 15,
      def: 5,
      speed: 4,
      isAlly: false
    },
    {
      id: 'demon1',
      name: 'DÃ©mon Mineur',
      sprite: 'ğŸ‘º',
      hp: 60,
      maxHp: 60,
      atk: 20,
      def: 8,
      speed: 6,
      isAlly: false
    },
    {
      id: 'skeleton1',
      name: 'Squelette',
      sprite: 'ğŸ’€',
      hp: 30,
      maxHp: 30,
      atk: 12,
      def: 3,
      speed: 3,
      isAlly: false
    }
  ];
  
  const allies = [testPlayer, testKnight];
  
  // VÃ©rifier que CombatSystem est chargÃ©
  if (typeof CombatSystem === 'undefined') {
    alert('âŒ Erreur : combat-system.js n\'est pas chargÃ© !');
    console.error('âŒ CombatSystem non dÃ©fini. VÃ©rifie que combat-system.js est bien chargÃ©.');
    return;
  }
  
  // Lancer le combat
  console.log('âœ… CrÃ©ation du combat avec:', { allies, enemies });
  const combat = new CombatSystem(allies, enemies, 'Chambre de Test');
  combat.initialize();
});

// ğŸ§ª Script de test pour le DÃ© du Destin
document.getElementById('test-dice-destiny-btn').addEventListener('click', async function() {
  console.log('ğŸ² Test du DÃ© du Destin...');

  if (typeof window.DiceSystem === 'undefined') {
    alert('âŒ Erreur : DiceSystem non chargÃ© !');
    return;
  }

  try {
    // Lancer le DÃ©
    const result = await window.DiceSystem.roll();
    console.log('âœ… RÃ©sultat du DÃ©:', result);

    // Afficher info du DÃ© dans la console
    console.log('ğŸ“Š Info du DÃ©:', window.DiceSystem.getInfo());

  } catch (error) {
    console.error('âŒ Erreur lors du lancer:', error);
    alert('Erreur: ' + error.message);
  }
});

// ==========================================
// RETOUR AU CAMP - Save & Return
// ==========================================
document.getElementById('btnReturnToCamp').addEventListener('click', function() {
  // Confirmation
  const confirmed = confirm('â›º Retourner au Camp ?\n\nLa progression du donjon actuel sera abandonnÃ©e, mais tes compagnons et ton or seront sauvegardÃ©s.');

  if (confirmed) {
    // Sauvegarder Ã©tat actuel du joueur (si disponible)
    if (typeof game !== 'undefined' && game.currentPlayer) {
      const currentPlayerData = localStorage.getItem('tlc_player');
      if (currentPlayerData) {
        const playerData = JSON.parse(currentPlayerData);

        // Mettre Ã  jour avec stats actuelles
        playerData.hp = game.currentPlayer.hp;
        playerData.maxHp = game.currentPlayer.maxHp || playerData.maxHp;
        playerData.atk = game.currentPlayer.atk;
        playerData.def = game.currentPlayer.def;
        playerData.level = game.currentPlayer.level || playerData.level;
        playerData.corruption = game.currentPlayer.corruption || playerData.corruption;
        playerData.gold = game.currentPlayer.gold || playerData.gold;

        // âœ… NOUVEAU : Mettre Ã  jour l'Ã©tat des compagnons
        if (game.currentPlayer.companions && game.currentPlayer.companions.length > 0) {
          playerData.companions = game.currentPlayer.companions.map(comp => ({
            id: comp.id,
            name: comp.name,
            hp: comp.hp,
            maxHp: comp.maxHp,
            atk: comp.atk,
            def: comp.def,
            morale: comp.morale,
            motivation: comp.motivation,
            backstory: comp.backstory
          }));
          console.log(`âš”ï¸ ${playerData.companions.length} compagnon(s) sauvegardÃ©(s)`);
        }

        // Sauvegarder
        localStorage.setItem('tlc_player', JSON.stringify(playerData));
        console.log('âœ… Progression sauvegardÃ©e avant retour au camp');
      }
    }

    // DÃ©clencher retour de donjon = nuit tombÃ©e
    const dayNightData = JSON.parse(localStorage.getItem('tlc_daynightcycle') || '{"timeOfDay":"morning","dayCount":1,"hour":6}');
    dayNightData.timeOfDay = 'night';
    dayNightData.hour = 20;
    localStorage.setItem('tlc_daynightcycle', JSON.stringify(dayNightData));
    console.log('ğŸŒ™ Retour de donjon : la nuit est tombÃ©e');

    // Rediriger vers camp
    window.location.href = 'camp.html';
  }
});
</script>

</body>
</html>